{% extends 'admins/home.html' %}
{% load custom_filters %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Students</h2>

    <div class="table-responsive">
        <table id="studentsTable" class="table table-striped table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Avatar</th>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Account Balance</th>
                    <th>Total Courses</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                   <td>
                        {% with first_initial=student.student.first_name|slice:":1"|upper last_initial=student.student.last_name|slice:":1"|upper %}
                        <div class="profile-avatar d-inline-block text-center rounded-circle" 
                            style="width:30px; height:30px; background-color: {{ first_initial|get_color }}; 
                                    line-height:30px; color:white; font-weight:bold; font-size:0.8rem;">
                            {{ first_initial }}{{ last_initial }}
                        </div>
                        {% endwith %}
                    </td>
                    <td>{{ student.student.first_name }} {{ student.student.last_name }}</td>
                    <td>{{ student.student.user.username }}</td>
                    <td>${{ student.balance }}</td>
                    <td>{{ student.student.user.enrollment_set.count }}</td> 
                    <td>{{ student.student.registration_date|date:"d M Y" }}</td>
                    <td>
                        <a href="{% url 'edit_student' student.student.id %}" class="btn btn-sm btn-primary mb-1">
                            <i class="bi bi-pencil-square"></i> Edit
                        </a>
                        <button class="btn btn-sm btn-success mb-1" onclick="openEditModal({{ student.student.id }}, '{{ student.student.user.username }}', {{ student.balance }})">
                            <i class="bi bi-currency-dollar"></i> Fund
                        </button>
                        <button class="btn btn-sm btn-danger mb-1">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No students found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Fund Wallet Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Fund <span id="usernameDisplay"></span>'s Wallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editStudentId" name="student_id" />
                        <div class="mb-3">
                            <label for="newBalance" class="form-label">New Balance</label>
                            <input type="number" class="form-control" id="newBalance" name="new_balance" placeholder="Enter new balance" required />
                        </div>
                        <div id="editResponseMessage" class="mt-3"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editForm" class="btn btn-primary">Update Balance</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables JS Initialization -->
<script>
$(document).ready(function() {
    $('#studentsTable').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search students..."
        },
        columnDefs: [
            { orderable: false, targets: [1, 7] } // disable sorting on Avatar and Actions
        ]
    });
});

function openEditModal(studentId, username, balance) {
    $('#editStudentId').val(studentId);
    $('#usernameDisplay').text(username);
    $('#newBalance').val(balance);
    var myModal = new bootstrap.Modal(document.getElementById('editModal'));
    myModal.show();
}
</script>
{% endblock %}
